name: ci

on:
  pull_request:
    paths:
      - "cmd/**"
      - "core/**"
      - "docs/**"
      - "docs-site/**"
      - "examples/**"
      - "internal/**"
      - "schemas/**"
      - "scripts/**"
      - "sdk/**"
      - "go.mod"
      - "go.sum"
      - "Makefile"
      - ".github/workflows/**"
  push:
    branches:
      - master
    paths:
      - "cmd/**"
      - "core/**"
      - "docs/**"
      - "docs-site/**"
      - "examples/**"
      - "internal/**"
      - "schemas/**"
      - "scripts/**"
      - "sdk/**"
      - "go.mod"
      - "go.sum"
      - "Makefile"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: '1.25.x'

      - name: Lint
        run: make lint

      - name: SAST fast
        run: make sast-fast

      - name: License check
        run: make license-check

      - name: Upload lint artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: lint-${{ matrix.os }}-artifacts
          path: wrkr-out/reports/**
          if-no-files-found: ignore

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: '1.25.x'

      - name: Setup Python
        if: runner.os != 'Windows'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.13'

      - name: Install uv
        if: runner.os != 'Windows'
        run: python -m pip install --upgrade pip uv

      - name: Test (non-windows)
        if: runner.os != 'Windows'
        run: make test-fast

      - name: Test (windows)
        if: runner.os == 'Windows'
        run: |
          go build ./cmd/wrkr
          go test ./cmd/wrkr -run 'TestRunVersionText|TestRunUnknownCommandJSON' -count=1
          go test ./core/errors -run 'TestExitCodeFor' -count=1

  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: '1.25.x'

      - name: Run e2e tests
        run: make test-e2e

  contracts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: '1.25.x'

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.13'

      - name: Install uv
        run: python -m pip install --upgrade pip uv

      - name: Run contract checks
        run: make test-contracts

  conformance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: '1.25.x'

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.13'

      - name: Install uv
        run: python -m pip install --upgrade pip uv

      - name: Run conformance suite
        env:
          WRKR_KEEP_TMP: "1"
        run: make test-conformance

      - name: Upload conformance artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: conformance-artifacts
          path: wrkr-out/**
          if-no-files-found: ignore

  acceptance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: '1.25.x'

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.13'

      - name: Install uv
        run: python -m pip install --upgrade pip uv

      - name: Run acceptance tests
        run: make test-acceptance

      - name: Upload acceptance artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: acceptance-artifacts
          path: wrkr-out/**
          if-no-files-found: ignore

  install-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: '1.25.x'

      - name: Install smoke
        run: make install-smoke

  release-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: '1.25.x'

      - name: Release smoke
        run: make release-smoke

  docs-site:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: docs-site/package-lock.json

      - name: Docs site install
        run: make docs-site-install

      - name: Docs site lint
        run: make docs-site-lint

      - name: Docs site build
        env:
          DOCS_SITE_BASE_PATH: /${{ github.event.repository.name }}
        run: make docs-site-build

  ci:
    runs-on: ubuntu-latest
    needs:
      - lint
      - test
      - e2e
      - contracts
      - conformance
      - acceptance
      - install-smoke
      - release-smoke
      - docs-site
    steps:
      - run: echo "ci checks passed"
