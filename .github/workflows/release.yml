name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to release (for example: v1.0.0)"
        required: true
        type: string
      publish_homebrew_tap:
        description: "Publish wrkr.rb into tap repository"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write
  attestations: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  acceptance-gate:
    runs-on: ubuntu-latest
    env:
      TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Checkout requested tag
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          git fetch --tags --force
          git checkout "refs/tags/${TAG_NAME}"

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff
        with:
          go-version: '1.25.x'

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.13'

      - name: Install uv
        run: python -m pip install --upgrade pip uv

      - name: Fast quality gates
        run: make lint-fast test-fast sast-fast

      - name: v1 acceptance lane
        run: make test-v1-acceptance

      - name: Install and release smoke
        run: make install-smoke release-smoke

  release:
    needs:
      - acceptance-gate
    runs-on: ubuntu-latest
    env:
      TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Checkout requested tag
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          git fetch --tags --force
          git checkout "refs/tags/${TAG_NAME}"

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff
        with:
          go-version: '1.25.x'

      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a
        with:
          distribution: goreleaser
          version: '~> v2'
          install-only: true

      - name: Build and publish release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: goreleaser release --clean

      - name: Verify release archives and checksums
        run: ./scripts/verify_release_assets.sh --dist dist --expected-tag "${TAG_NAME}"

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b "${HOME}/.local/bin" v1.25.1
          echo "${HOME}/.local/bin" >> "${GITHUB_PATH}"

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
            | sh -s -- -b "${HOME}/.local/bin" v0.92.2
          echo "${HOME}/.local/bin" >> "${GITHUB_PATH}"

      - name: Generate SBOM
        run: syft dir:./dist -o spdx-json=./dist/wrkr.sbom.spdx.json

      - name: Generate vulnerability report
        run: grype sbom:./dist/wrkr.sbom.spdx.json -o sarif > ./dist/wrkr.vuln.sarif

      - name: Install Cosign
        uses: sigstore/cosign-installer@f713795cb21599bc4e5c4b58cbad1da852d7eeb9

      - name: Sign checksums with keyless cosign
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign-blob --yes \
            --output-signature ./dist/checksums.txt.sig \
            --output-certificate ./dist/checksums.txt.pem \
            ./dist/checksums.txt

      - name: Verify integrity artifacts
        run: |
          ./scripts/verify_release_assets.sh \
            --dist dist \
            --expected-tag "${TAG_NAME}" \
            --require-file wrkr.sbom.spdx.json \
            --require-file wrkr.vuln.sarif \
            --require-file checksums.txt.sig \
            --require-file checksums.txt.pem
          sha256sum \
            ./dist/wrkr.sbom.spdx.json \
            ./dist/wrkr.vuln.sarif \
            ./dist/checksums.txt.sig \
            ./dist/checksums.txt.pem \
            > ./dist/integrity-artifacts.sha256

      - name: Attest release artifacts provenance
        uses: actions/attest-build-provenance@96b4a1ef7235a096b17240c259729fdd70c83d45
        with:
          subject-path: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
            dist/wrkr.sbom.spdx.json
            dist/wrkr.vuln.sarif
            dist/checksums.txt.sig
            dist/checksums.txt.pem

      - name: Render Homebrew formula
        run: |
          ./scripts/render_homebrew_formula.sh \
            --version "${TAG_NAME}" \
            --checksums ./dist/checksums.txt \
            --repo-owner "${{ github.repository_owner }}" \
            --repo-name "${{ github.event.repository.name }}" \
            --output ./dist/wrkr.rb

      - name: Validate Homebrew publish input
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.publish_homebrew_tap == 'true' }}
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [[ -z "${HOMEBREW_TAP_TOKEN}" ]]; then
            echo "publish_homebrew_tap=true requires HOMEBREW_TAP_TOKEN"
            exit 1
          fi

      - name: Publish Homebrew formula
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.publish_homebrew_tap == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          ./scripts/publish_homebrew_tap.sh \
            --formula ./dist/wrkr.rb \
            --tap-repo "${{ github.repository_owner }}/homebrew-wrkr" \
            --tap-branch master \
            --apply

      - name: Upload release integrity artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: release-integrity
          path: |
            dist/checksums.txt
            dist/checksums.txt.sig
            dist/checksums.txt.pem
            dist/wrkr.sbom.spdx.json
            dist/wrkr.vuln.sarif
            dist/integrity-artifacts.sha256
            dist/wrkr.rb
